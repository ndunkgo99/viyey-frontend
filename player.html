<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>VIYEY - Pemutar Video</title>
  <!-- üî• Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: #000;
      color: white;
      display: flex;
      flex-direction: column;
      min-height: 100dvh;
      padding: 0;
      margin: 0;
      overflow-x: hidden;
    }
    .hex-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }
    .hex-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    .hex {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #004080, #0080ff);
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
      box-shadow: 0 0 15px rgba(0, 240, 255, 0.5), inset 0 0 10px rgba(0, 240, 255, 0.3);
      transform: rotate(30deg);
      animation: float 8s ease-in-out infinite;
    }
    .hex:nth-child(even) {
      transform: rotate(-30deg);
    }
    @keyframes float {
      0%, 100% { transform: rotate(30deg) translateY(0); }
      50% { transform: rotate(-30deg) translateY(-8px); }
    }
    .player-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.8);
      border-bottom: 2px solid rgba(0, 240, 255, 0.7);
      backdrop-filter: blur(5px);
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0, 240, 255, 0.6);
      flex-shrink: 0;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.3rem;
      font-weight: bold;
      color: white;
      text-decoration: none;
    }
    .logo-img {
      width: 36px;
      height: 36px;
      background: url('Logo.png') no-repeat center;
      background-size: contain;
    }
    .logo-text {
      text-shadow: 0 0 15px rgba(0, 240, 255, 0.9);
    }
    .main-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      padding: 0 8px;
      gap: 16px;
    }
    .video-wrapper {
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
      position: relative;
      overflow: hidden;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 240, 255, 0.6);
    }
    .embed-player {
      width: 100%;
      height: 100%;
      border: none;
    }
    .info-section {
      background: rgba(10, 10, 26, 0.9);
      border: 2px solid rgba(0, 240, 255, 0.5);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 0 20px rgba(0, 128, 255, 0.4);
    }
    .filename {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 12px;
      color: #00f0ff;
      text-shadow: 0 0 10px rgba(0, 240, 255, 0.7);
    }
    .action-row {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      font-size: 14px;
    }
    .stat-item, .share-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      color: #aaa;
    }
    .stat-item:hover, .share-btn:hover {
      color: white;
    }
    .share-btn {
      color: #00f0ff;
      text-shadow: 0 0 8px rgba(0, 240, 255, 0.6);
    }
    .url-box {
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(0, 240, 255, 0.3);
      border-radius: 8px;
      padding: 10px 14px;
      margin: 18px 0;
    }
    .url-input {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      font-size: 14px;
      outline: none;
    }
    .copy-btn {
      background: linear-gradient(135deg, #0080ff, #00f0ff);
      color: black;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(0, 240, 255, 0.6);
    }
    .download-section {
      text-align: center;
      padding: 10px 0;
    }
    .big-download-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #0080ff, #00f0ff);
      color: black;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-decoration: none;
      box-shadow: 0 0 20px rgba(0, 240, 255, 0.8);
    }
    .big-download-btn:hover {
      background: linear-gradient(135deg, #0066cc, #00ccff);
    }
    #copyNotification {
      position: fixed;
      bottom: max(20px, env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      background: rgba(10, 10, 26, 0.95);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
      font-size: 14px;
      border: 2px solid rgba(0, 240, 255, 0.5);
      box-shadow: 0 0 15px rgba(0, 240, 255, 0.6);
    }
    #copyNotification.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="hex-bg">
    <div class="hex-row" style="transform: translateY(-40vh);">
      <div class="hex"></div><div class="hex"></div><div class="hex"></div>
    </div>
    <div class="hex-row" style="transform: translateY(-60vh);">
      <div class="hex"></div><div class="hex"></div><div class="hex"></div>
    </div>
  </div>

  <div class="player-header">
    <a href="index.html" class="logo">
      <div class="logo-img"></div>
      <div class="logo-text">VIYEY</div>
    </a>
  </div>

  <div class="main-container">
    <div class="video-wrapper">
      <iframe
        id="embedPlayer"
        class="embed-player"
        frameborder="0"
        allow="autoplay; fullscreen; picture-in-picture"
        sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
      ></iframe>
    </div>

    <div class="info-section">
      <div class="filename" id="videoTitle">Memuat video...</div>

      <div class="action-row" id="actionRow">
        <div class="stat-item" onclick="likeVideo()" aria-label="Suka">
          <i id="likeIcon">ü§ç</i> <span id="likeCount">0</span>
        </div>
        <div class="stat-item" onclick="incrementView()" aria-label="Jumlah tayangan">
          <i>üëÅÔ∏è</i> <span id="viewCount">0</span>
        </div>
        <div class="share-btn" onclick="shareVideo()" aria-label="Bagikan">
          <i>üì§</i> Bagikan
        </div>
      </div>

      <div class="url-box">
        <input type="text" class="url-input" id="videoUrl" readonly />
        <button class="copy-btn" onclick="copyUrl()">üìã</button>
      </div>

      <div class="download-section" id="downloadSection">
        <a href="#" id="downloadLink" class="big-download-btn" aria-label="Unduh video">
          Unduh Video ‚¨áÔ∏è
        </a>
      </div>
    </div>
  </div>

  <div id="copyNotification">Tautan disalin ke clipboard!</div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAzIMDg9CaToG0bbA20nfT9aa0OH_enEtg",
      authDomain: "project-1-3ad96.firebaseapp.com",
      projectId: "project-1-3ad96",
      storageBucket: "project-1-3ad96.firebasestorage.app",
      messagingSenderId: "954488595209",
      appId: "1:954488595209:web:b20a6b151ac5777ff9e9d8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const videoId = urlParams.get('id');
    if (!videoId) {
      document.getElementById('videoTitle').textContent = 'ID video tidak ditemukan';
      throw new Error('ID video tidak ada di URL.');
    }

    const embed = document.getElementById('embedPlayer');
    const videoTitle = document.getElementById('videoTitle');
    const videoUrl = document.getElementById('videoUrl');
    const downloadLink = document.getElementById('downloadLink');
    const likeCount = document.getElementById('likeCount');
    const viewCount = document.getElementById('viewCount');
    const likeIcon = document.getElementById('likeIcon');
    const copyNotification = document.getElementById('copyNotification');
    const downloadSection = document.getElementById('downloadSection');

    let videoData = null;
    let isLiked = false;

    async function loadVideoFromFirestore() {
      try {
        const doc = await db.collection('videos').doc(videoId).get();
        if (!doc.exists) {
          videoTitle.textContent = 'Video tidak ditemukan';
          return;
        }

        videoData = doc.data();
        videoTitle.textContent = videoData.title || 'Tanpa Judul';

        const fullUrl = `${window.location.origin}${window.location.pathname}?id=${videoId}`;
        videoUrl.value = fullUrl;

        // üîß Update: Gunakan embedUrl jika ada, jika tidak gunakan iframe dari bunnyUrl
        if (videoData.embedUrl) {
          embed.src = videoData.embedUrl;
        } else if (videoData.bunnyUrl) {
          // Konversi bunnyUrl ke embed URL untuk iframe
          const videoName = videoData.bunnyUrl.split('/').pop();
          const embedSrc = `https://iframe.mediadelivery.net/embed/${videoData.bunnyVideoId || videoId}?filename=${encodeURIComponent(videoName)}&autoplay=false`;
          embed.src = embedSrc;
        } else {
          videoTitle.textContent = 'URL video tidak tersedia';
          return;
        }

        // üîß Update: Gunakan shrinkMeUrl untuk download (dari Worker terbaru)
        if (videoData.shrinkMeUrl) {
          downloadLink.href = videoData.shrinkMeUrl;
          downloadLink.target = '_blank';
        } else if (videoData.downloadUrl) {
          // Fallback ke downloadUrl lama jika shrinkMeUrl tidak ada
          downloadLink.href = videoData.downloadUrl;
          downloadLink.target = '_blank';
        } else if (videoData.bunnyUrl) {
          // Fallback ke download langsung dari Bunny.net
          downloadLink.href = videoData.bunnyUrl;
          downloadLink.target = '_blank';
        } else {
          downloadSection.style.display = 'none';
        }

        likeCount.textContent = videoData.likes || 0;
        viewCount.textContent = videoData.views || 0;

        const likedVideos = JSON.parse(localStorage.getItem('viyey_liked_videos') || '[]');
        isLiked = likedVideos.includes(videoId);
        likeIcon.textContent = isLiked ? '‚ù§Ô∏è' : 'ü§ç';

      } catch (err) {
        console.error("Error loading video:", err);
        videoTitle.textContent = 'Gagal memuat video';
      }
    }

    async function likeVideo() {
      if (!videoData) return;
      const user = firebase.auth().currentUser;
      if (!user) {
        alert('Silakan login untuk menyukai video.');
        return;
      }

      try {
        await db.collection('videos').doc(videoId).update({
          likes: firebase.firestore.FieldValue.increment(1)
        });
        const newLikes = (videoData.likes || 0) + 1;
        videoData.likes = newLikes;
        likeCount.textContent = newLikes;

        let likedVideos = JSON.parse(localStorage.getItem('viyey_liked_videos') || '[]');
        if (!likedVideos.includes(videoId)) {
          likedVideos.push(videoId);
          localStorage.setItem('viyey_liked_videos', JSON.stringify(likedVideos));
          isLiked = true;
          likeIcon.textContent = '‚ù§Ô∏è';
        }
      } catch (err) {
        console.error("Like error:", err);
        alert('Gagal menyukai video.');
      }
    }

    async function incrementView() {
      if (!videoData) return;
      try {
        await db.collection('videos').doc(videoId).update({
          views: firebase.firestore.FieldValue.increment(1)
        });
        const newViews = (videoData.views || 0) + 1;
        videoData.views = newViews;
        viewCount.textContent = newViews;
      } catch (err) {
        console.error("View error:", err);
      }
    }

    function copyUrl() {
      videoUrl.select();
      document.execCommand('copy');
      copyNotification.classList.add('show');
      setTimeout(() => copyNotification.classList.remove('show'), 2000);
    }

    function shareVideo() {
      copyUrl();
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadVideoFromFirestore();
    });
  </script>
</body>
</html>